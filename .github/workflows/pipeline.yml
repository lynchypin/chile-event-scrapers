name: Event Gatherer Pipeline

on:
  schedule:
    - cron: '0 */12 * * *'

  workflow_dispatch:
    inputs:
      job_to_run:
        description: 'Which job to run? (all / publisher_only)'
        required: true
        default: 'all'

permissions:
  contents: write

jobs:
  gather-and-update-db:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event.inputs.job_to_run != 'publisher_only'

    steps:
      - name: Check out the repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: gatherer_requirements.txt

      - name: Install Python dependencies
        run: |
          pip install -r gatherer_requirements.txt

      - name: Run the Gatherer script
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          python gatherer.py

      - name: Commit and push the updated database
        run: |
          git config --global user.name 'GitHub Actions Bot'
          git config --global user.email 'actions@github.com'
          git add events.db

          if git diff --staged --quiet; then
            echo "No changes to commit"
            exit 0
          fi

          git fetch origin main
          git rebase origin/main || {
            echo "Rebase failed, trying merge strategy"
            git rebase --abort
            git merge origin/main -m "Merge remote changes"
          }

          git commit -m "Automated: Update event database [skip ci]"
          git push origin HEAD:main

  prune-and-publish-json:
    runs-on: ubuntu-latest
    needs: [gather-and-update-db]
    if: always()

    steps:
      - name: Check out the repository
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 1

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: publisher_requirements.txt

      - name: Install Python dependencies
        run: |
          pip install -r publisher_requirements.txt

      - name: Run Publisher in Batch Mode
        id: publisher
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          python publisher.py \
            --batch \
            --repo-url "https://github.com/lynchypin/Test-event-finder.git" \
            --branch "main" \
            --es-file-path "public/data/events_es.json" \
            --en-file-path "public/data/events_en.json"

      - name: Create dummy ads.json to prevent 404s
        if: steps.publisher.outputs.events_changed == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          REPO_OWNER="lynchypin"
          REPO_NAME="Test-event-finder"
          FILE_PATH="public/data/ads_es.json"
          BRANCH="main"
          CONTENT='[]'

          API_URL="https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${FILE_PATH}"

          RESPONSE=$(curl -s -H "Authorization: token ${GITHUB_TOKEN}" \
            -H "Accept: application/vnd.github.v3+json" \
            "${API_URL}?ref=${BRANCH}")

          SHA=$(echo "$RESPONSE" | jq -r '.sha // empty')

          CONTENT_B64=$(echo -n "$CONTENT" | base64)

          if [ -n "$SHA" ]; then
            curl -X PUT -H "Authorization: token ${GITHUB_TOKEN}" \
              -H "Accept: application/vnd.github.v3+json" \
              "${API_URL}" \
              -d "{\"message\":\"ci: Update placeholder ads_es.json\",\"content\":\"${CONTENT_B64}\",\"sha\":\"${SHA}\",\"branch\":\"${BRANCH}\"}"
          else
            curl -X PUT -H "Authorization: token ${GITHUB_TOKEN}" \
              -H "Accept: application/vnd.github.v3+json" \
              "${API_URL}" \
              -d "{\"message\":\"ci: Add placeholder ads_es.json\",\"content\":\"${CONTENT_B64}\",\"branch\":\"${BRANCH}\"}"
          fi

      - name: Trigger Netlify Redeploy
        if: steps.publisher.outputs.events_changed == 'true'
        env:
          NETLIFY_BUILD_HOOK_URL: ${{ secrets.NETLIFY_BUILD_HOOK_URL }}
        run: |
          if [ -n "$NETLIFY_BUILD_HOOK_URL" ]; then
            curl -X POST -d {} "$NETLIFY_BUILD_HOOK_URL"
            echo "Netlify deployment triggered."
          else
            echo "NETLIFY_BUILD_HOOK_URL not set, skipping deployment trigger."
          fi